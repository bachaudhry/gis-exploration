# **Download and Explore Satellite Imagery Data for Floods**


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

``` python
import random, os, gc, psutil, glob, re, multiprocessing # mem management, parallel processing & file handling
import numpy as np
import pandas as pd
from time import time
from tqdm.notebook import tqdm # Progress bars
from pathlib import Path
import matplotlib.pyplot as plt
import seaborn as sns
from joblib import Parallel, delayed
# Geospatial libraries
import rasterio
from rasterio.plot import show
import geopandas as gpd
from shapely.geometry import Point, Polygon
import folium
from pyproj import CRS #python interface to PROJ (cartographic projections and coordinate transformations lib)
# Image Processing
from skimage import exposure, filters, morphology
import cv2
```

``` python
import warnings 
warnings.filterwarnings('ignore')
```

## Sen1Floods11

This data’s citation is: \> Bonafilia, D., Tellman, B., Anderson, T.,
Issenberg, E. 2020. Sen1Floods11: a georeferenced dataset to train and
test deep learning flood algorithms for Sentinel-1. The IEEE/CVF
Conference on Computer Vision and Pattern Recognition (CVPR) Workshops,
2020, pp. 210-211.

[The paper is available via open
access](http://openaccess.thecvf.com/content_CVPRW_2020/html/w11/Bonafilia_Sen1Floods11_A_Georeferenced_Dataset_to_Train_and_Test_Deep_Learning_CVPRW_2020_paper.html)

The GCS bucket is split into subfolders containing data, checkpoints,
training/testing splits and a [STAC](https://stacspec.org) compliant
catalogue.

For additional details on how the data is structured and what is
represented in the meta data, head over to the [github
repo](https://github.com/cloudtostreet/Sen1Floods11/tree/master)

``` python
path_data1 = Path('/home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data')
```

``` python
!ls -l /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/
```

    total 10256
    -rw-r--r-- 1 ba_ch ba_ch    14092 Oct 15  2020 Sen1Floods11_Metadata.geojson
    drwxr-xr-x 6 ba_ch ba_ch     4096 Mar 10 16:03 catalog
    -rw-r--r-- 1 ba_ch ba_ch 10467733 Oct 15  2020 catalog.zip
    drwxr-xr-x 2 ba_ch ba_ch     4096 Mar 10 16:31 checkpoints
    drwxr-xr-x 4 ba_ch ba_ch     4096 Mar 10 18:16 data
    drwxr-xr-x 4 ba_ch ba_ch     4096 Mar 10 18:19 splits

Creating functions to explore the dataset structure. I’ll work on
ensuring that the function runs as expected before refactoring and
chucking it into a class.

Run simplified function with debug prints.

``` python
def simple_check(root_dir):
    root_dir = str(root_dir)
    print(f"Checking directory: {root_dir}")
    if not os.path.exists(root_dir):
        print(f"Path doesn't exist: {root_dir}")
        return False

    file_count = 0
    for dirpath, dirnames, filenames in os.walk(root_dir):
        file_count += len(filenames)
        print(f"Found directory: {dirpath} with {len(filenames)} files")
        if len(filenames) > 0: print(f"Sample file: {filenames[0]}")

    print(f"Total files found: {file_count}")
    return file_count > 0
```

``` python
simple_check(path_data1)
```

    Checking directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data with 0 files
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events with 0 files
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events/HandLabeled with 0 files
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events/HandLabeled/LabelHand with 446 files
    Sample file: Sri-Lanka_321316_LabelHand.tif
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events/HandLabeled/JRCWaterHand with 446 files
    Sample file: India_747992_JRCWaterHand.tif
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events/HandLabeled/S1OtsuLabelHand with 446 files
    Sample file: Spain_2523247_S1OtsuLabelHand.tif
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events/HandLabeled/S2Hand with 446 files
    Sample file: Spain_2594119_S2Hand.tif
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events/HandLabeled/S1Hand with 446 files
    Sample file: India_103447_S1Hand.tif
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events/WeaklyLabeled with 0 files
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events/WeaklyLabeled/S2IndexLabelWeak with 4385 files
    Sample file: Paraguay_8435789_S2IndexLabelWeak.tif
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events/WeaklyLabeled/S1Weak with 4384 files
    Sample file: USA_6224033_S1Weak.tif
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events/WeaklyLabeled/S2Weak with 4384 files
    Sample file: Colombia_3229730_S2Weak.tif
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/flood_events/WeaklyLabeled/S1OtsuLabelWeak with 4384 files
    Sample file: Mekong_3211831_S1OtsuLabelWeak.tif
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/perm_water with 0 files
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/perm_water/S1Perm with 814 files
    Sample file: sentinel_1_152_rural_156.5748410406182_-8.001183516149558.tif
    Found directory: /home/ba_ch/nbs/gis-exploration/data/downloads/v1.1/data/perm_water/JRCPerm with 814 files
    Sample file: water_2_537_inhabited_-61.26831602040957_13.200076188968426.tif
    Total files found: 21395

    True

21395 checks out after manual confirmation. Lets flesh out this
function.

``` python
def explore_data(root_dir):
    """
    Explore the structure of the Sen1Floods11 dataset, handling multiple levels of folders
    and subfolders.
    """
    root_dir = str(root_dir)
    if not os.path.exists(root_dir):
        print(f"Error: Path {root_dir} does not exist")
        return {}
        
    dataset_info = {
        'total_size_gb': 0,
        'num_files' : 0,
        'file_types': {},
        'folders': {},
        'subfolders_structure': {},
        'tiff_stats': {
            'dimensions': [],
            'bands_count': {},
            'crs_types': {}
        },
    }

    # Walk through directories and files
    for dirpath, dirnames, filenames in os.walk(root_dir):
        rel_path = os.path.relpath(dirpath, root_dir)
        if rel_path == '.':
            rel_path = 'root'
        
        # Parse folder structure
        path_parts = rel_path.split(os.sep)
        current_level = dataset_info['subfolders_structure']
        
        # Nested folder dictionary
        if rel_path != 'root':
            for i, part in enumerate(path_parts):
                if part not in current_level:
                    current_level[part] = {'files': 0, 'size_mb': 0, 'subfolders': {}}
                if i < len(path_parts) - 1 :
                    current_level = current_level[part]['subfolders']
                else:
                    current_folder = current_level[part]
        else: current_folder = dataset_info['subfolders_structure']
        
        # Add folder info
        dataset_info['folders'][rel_path] = {
            'num_files': len(filenames),
            'size_mb': 0,
            'file_types': {},
        }
        # Process files
        for filename in filenames:
            filepath = os.path.join(dirpath, filename)
            try: # added additional exception handling 
                file_size = os.path.getsize(filepath) / (1024*1024) # result in MBs
            except (FileNotFoundError, PermissionError) as e: 
                print(f"Error accessing {filepath}: {e}")
                continue
            
            # Update dataset info
            dataset_info['num_files'] += 1
            dataset_info['total_size_gb'] += file_size / 1024
            dataset_info['folders'][rel_path]['size_mb'] += file_size

            # Update the nested structure of folders
            if rel_path != 'root':
                current_folder['files'] += 1
                current_folder['size_mb'] += file_size
            
            # Track file types
            file_ext = os.path.splitext(filename)[1].lower()
            if file_ext not in dataset_info['file_types']:
                dataset_info['file_types'][file_ext] = {'count': 0, 'size_mb': 0}
            dataset_info['file_types'][file_ext]['count'] += 1
            dataset_info['file_types'][file_ext]['size_mb'] += file_size

            # Track file types per folder
            if file_ext not in dataset_info['folders'][rel_path]['file_types']:
                dataset_info['folders'][rel_path]['file_types'][file_ext] = 0
            dataset_info['folders'][rel_path]['file_types'][file_ext] += 1
    
            # Get info on TIFF files (limited sample)
            if file_ext in ['.tif', '.tiff']:
                try:
                    with rasterio.open(filepath) as src:
                        if len(dataset_info['tiff_stats']['dimensions']) < 10: # Sample upto 10
                            dataset_info['tiff_stats']['dimensions'].append({
                                'file': os.path.relpath(filepath, root_dir),
                                'width': src.width,
                                'height': src.height,
                                'count': src.count,
                                'crs': str(src.crs),
                                'transform': str(src.transform),
                                'size_mb': file_size
                            })
                        # Track band counts
                        band_count = src.count
                        if band_count not in dataset_info['tiff_stats']['bands_count']:
                            dataset_info['tiff_stats']['bands_count'][band_count] = 0
                        dataset_info['tiff_stats']['bands_count'][band_count] += 1
                        
                        # Track CRS types
                        crs_str = str(src.crs)
                        if crs_str not in dataset_info['tiff_stats']['crs_types']:
                            dataset_info['tiff_stats']['crs_types'][crs_str] = 0
                        dataset_info['tiff_stats']['crs_types'][crs_str] += 1   
                except Exception as e: print(f"Error reading {filepath}: {e}")
    # Round the total size, folder sizes and file type sizes
    dataset_info['total_size_gb'] = round(dataset_info['total_size_gb'], 2)
    for folder in dataset_info['folders']:
        dataset_info['folders'][folder]['size_mb'] = round(dataset_info['folders'][folder]['size_mb'], 2)
    for file_type in dataset_info['file_types']:
        dataset_info['file_types'][file_type]['size_mb'] = round(dataset_info['file_types'][file_type]['size_mb'], 2)

    return dataset_info
```

``` python
explore_data(path_data1)
```

    {'total_size_gb': 33.81,
     'num_files': 21395,
     'file_types': {'.tif': {'count': 21394, 'size_mb': 34621.66},
      '': {'count': 1, 'size_mb': 0.01}},
     'folders': {'root': {'num_files': 0, 'size_mb': 0, 'file_types': {}},
      'flood_events': {'num_files': 0, 'size_mb': 0, 'file_types': {}},
      'flood_events/HandLabeled': {'num_files': 0, 'size_mb': 0, 'file_types': {}},
      'flood_events/HandLabeled/LabelHand': {'num_files': 446,
       'size_mb': 2.44,
       'file_types': {'.tif': 446}},
      'flood_events/HandLabeled/JRCWaterHand': {'num_files': 446,
       'size_mb': 0.49,
       'file_types': {'.tif': 446}},
      'flood_events/HandLabeled/S1OtsuLabelHand': {'num_files': 446,
       'size_mb': 1.63,
       'file_types': {'.tif': 446}},
      'flood_events/HandLabeled/S2Hand': {'num_files': 446,
       'size_mb': 971.42,
       'file_types': {'.tif': 446}},
      'flood_events/HandLabeled/S1Hand': {'num_files': 446,
       'size_mb': 695.7,
       'file_types': {'.tif': 446}},
      'flood_events/WeaklyLabeled': {'num_files': 0,
       'size_mb': 0,
       'file_types': {}},
      'flood_events/WeaklyLabeled/S2IndexLabelWeak': {'num_files': 4385,
       'size_mb': 31.47,
       'file_types': {'.tif': 4384, '': 1}},
      'flood_events/WeaklyLabeled/S1Weak': {'num_files': 4384,
       'size_mb': 6983.46,
       'file_types': {'.tif': 4384}},
      'flood_events/WeaklyLabeled/S2Weak': {'num_files': 4384,
       'size_mb': 24501.7,
       'file_types': {'.tif': 4384}},
      'flood_events/WeaklyLabeled/S1OtsuLabelWeak': {'num_files': 4384,
       'size_mb': 17.31,
       'file_types': {'.tif': 4384}},
      'perm_water': {'num_files': 0, 'size_mb': 0, 'file_types': {}},
      'perm_water/S1Perm': {'num_files': 814,
       'size_mb': 1410.32,
       'file_types': {'.tif': 814}},
      'perm_water/JRCPerm': {'num_files': 814,
       'size_mb': 5.72,
       'file_types': {'.tif': 814}}},
     'subfolders_structure': {'flood_events': {'files': 0,
       'size_mb': 0,
       'subfolders': {'HandLabeled': {'files': 0,
         'size_mb': 0,
         'subfolders': {'LabelHand': {'files': 446,
           'size_mb': 2.4355697631835938,
           'subfolders': {}},
          'JRCWaterHand': {'files': 446,
           'size_mb': 0.4912405014038086,
           'subfolders': {}},
          'S1OtsuLabelHand': {'files': 446,
           'size_mb': 1.6329212188720703,
           'subfolders': {}},
          'S2Hand': {'files': 446, 'size_mb': 971.4201326370239, 'subfolders': {}},
          'S1Hand': {'files': 446,
           'size_mb': 695.7015371322632,
           'subfolders': {}}}},
        'WeaklyLabeled': {'files': 0,
         'size_mb': 0,
         'subfolders': {'S2IndexLabelWeak': {'files': 4385,
           'size_mb': 31.47349739074707,
           'subfolders': {}},
          'S1Weak': {'files': 4384,
           'size_mb': 6983.455281257629,
           'subfolders': {}},
          'S2Weak': {'files': 4384,
           'size_mb': 24501.70032596588,
           'subfolders': {}},
          'S1OtsuLabelWeak': {'files': 4384,
           'size_mb': 17.312772750854492,
           'subfolders': {}}}}}},
      'perm_water': {'files': 0,
       'size_mb': 0,
       'subfolders': {'S1Perm': {'files': 814,
         'size_mb': 1410.3182640075684,
         'subfolders': {}},
        'JRCPerm': {'files': 814,
         'size_mb': 5.719854354858398,
         'subfolders': {}}}}},
     'tiff_stats': {'dimensions': [{'file': 'flood_events/HandLabeled/LabelHand/Sri-Lanka_321316_LabelHand.tif',
        'width': 512,
        'height': 512,
        'count': 1,
        'crs': 'EPSG:4326',
        'transform': '| 0.00, 0.00, 81.50|\n| 0.00,-0.00, 8.00|\n| 0.00, 0.00, 1.00|',
        'size_mb': 0.006531715393066406},
       {'file': 'flood_events/HandLabeled/LabelHand/Sri-Lanka_233609_LabelHand.tif',
        'width': 512,
        'height': 512,
        'count': 1,
        'crs': 'EPSG:4326',
        'transform': '| 0.00, 0.00, 81.09|\n| 0.00,-0.00, 7.86|\n| 0.00, 0.00, 1.00|',
        'size_mb': 0.0037832260131835938},
       {'file': 'flood_events/HandLabeled/LabelHand/Nigeria_984831_LabelHand.tif',
        'width': 512,
        'height': 512,
        'count': 1,
        'crs': 'EPSG:4326',
        'transform': '| 0.00, 0.00, 5.75|\n| 0.00,-0.00, 8.88|\n| 0.00, 0.00, 1.00|',
        'size_mb': 0.009843826293945312},
       {'file': 'flood_events/HandLabeled/LabelHand/Mekong_922373_LabelHand.tif',
        'width': 512,
        'height': 512,
        'count': 1,
        'crs': 'EPSG:4326',
        'transform': '| 0.00, 0.00, 105.97|\n| 0.00,-0.00, 12.23|\n| 0.00, 0.00, 1.00|',
        'size_mb': 0.015026092529296875},
       {'file': 'flood_events/HandLabeled/LabelHand/Paraguay_205585_LabelHand.tif',
        'width': 512,
        'height': 512,
        'count': 1,
        'crs': 'EPSG:4326',
        'transform': '| 0.00, 0.00,-56.80|\n| 0.00,-0.00,-24.42|\n| 0.00, 0.00, 1.00|',
        'size_mb': 0.0009679794311523438},
       {'file': 'flood_events/HandLabeled/LabelHand/Paraguay_148318_LabelHand.tif',
        'width': 512,
        'height': 512,
        'count': 1,
        'crs': 'EPSG:4326',
        'transform': '| 0.00, 0.00,-56.30|\n| 0.00,-0.00,-23.92|\n| 0.00, 0.00, 1.00|',
        'size_mb': 0.0031185150146484375},
       {'file': 'flood_events/HandLabeled/LabelHand/Sri-Lanka_551926_LabelHand.tif',
        'width': 512,
        'height': 512,
        'count': 1,
        'crs': 'EPSG:4326',
        'transform': '| 0.00, 0.00, 81.45|\n| 0.00,-0.00, 8.00|\n| 0.00, 0.00, 1.00|',
        'size_mb': 0.003987312316894531},
       {'file': 'flood_events/HandLabeled/LabelHand/USA_527077_LabelHand.tif',
        'width': 512,
        'height': 512,
        'count': 1,
        'crs': 'EPSG:4326',
        'transform': '| 0.00, 0.00,-95.25|\n| 0.00,-0.00, 38.59|\n| 0.00, 0.00, 1.00|',
        'size_mb': 0.0017709732055664062},
       {'file': 'flood_events/HandLabeled/LabelHand/India_324254_LabelHand.tif',
        'width': 512,
        'height': 512,
        'count': 1,
        'crs': 'EPSG:4326',
        'transform': '| 0.00, 0.00, 93.32|\n| 0.00,-0.00, 26.03|\n| 0.00, 0.00, 1.00|',
        'size_mb': 0.003131866455078125},
       {'file': 'flood_events/HandLabeled/LabelHand/USA_348639_LabelHand.tif',
        'width': 512,
        'height': 512,
        'count': 1,
        'crs': 'EPSG:4326',
        'transform': '| 0.00, 0.00,-94.98|\n| 0.00,-0.00, 39.00|\n| 0.00, 0.00, 1.00|',
        'size_mb': 0.004900932312011719}],
      'bands_count': {1: 10920, 13: 4830, 2: 5644},
      'crs_types': {'EPSG:4326': 21394}}}
